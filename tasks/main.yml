---

- name: Install nginx
  ansible.builtin.package:
    name: nginx
    state: present

- name: Create configuration directories
  ansible.builtin.file:
    path: /etc/nginx/{{ item }}
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - ssl
    - conf.d
    - conf.d/locations

- name: Configure nginx
  ansible.builtin.template:
    src: '{{ item.src }}'
    dest: /etc/nginx/{{ item.dest }}
    mode: '0644'
    owner: root
    group: root
  notify: Reload nginx
  when: item.src is truthy
  loop:
    - src: '{{ nginx_base_config }}'
      dest: nginx.conf
    - src: '{{ nginx_tls_config }}'
      dest: conf.d/tls.conf
    - src: '{{ nginx_http_config }}'
      dest: conf.d/http.conf

- name: Create root locations file
  ansible.builtin.copy:
    src: root.conf
    dest: /etc/nginx/conf.d/locations/root.conf
    owner: root
    group: root
    mode: '0644'
    force: false
  notify: Reload nginx

- name: Copy Diffie-Hellmann parameter
  ansible.builtin.copy:
    src: dhparam.pem
    dest: /etc//nginx/ssl/dhparam.pem
    owner: root
    group: root
    mode: '0640'
  notify: Reload nginx

- name: Install dummy tls certificate
  ansible.builtin.copy:
    src: dummy-tls-{{ item }}.pem
    dest: /etc/nginx/ssl/{{ inventory_hostname }}.{{ item }}
    owner: root
    group: root
    mode: '0400'
    force: false
  notify: Reload nginx
  loop:
    - key
    - crt

- name: SELinux settings
  when: configure_for_selinux
  block:
    - name: Install dependencies
      ansible.builtin.package:
        name:
          - python3-libselinux
          - python3-libsemanage

    - name: Allow nginx to act as reverse proxy
      ansible.posix.seboolean:
        name: httpd_can_network_connect
        state: true
        persistent: true

- name: Configure firewalld
  ansible.posix.firewalld:
    service: '{{ item }}'
    state: enabled
    permanent: true
    immediate: true
  loop:
    - http
    - https
  when: configure_for_firewalld

- name: Configure ufw
  community.general.ufw:
    rule: allow
    name: Nginx Full
  when: configure_for_ufw

- name: Enable nginx
  ansible.builtin.service:
    name: nginx
    enabled: true
    state: started
